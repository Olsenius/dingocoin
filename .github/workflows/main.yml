name: Continuous Integration on master branch
on:
  push:
    branches:
    - master
    - develop
    - Develop-Doge-Parity
    - macos-build
  pull_request:
    branches:
    - master
    - develop
    - Develop-Doge-Parity
env:
  SOURCE_ARTIFACT: ${{ github.workspace }}/source
jobs:
  create-source-distribution:
    name: Create Source Distribution
    runs-on: ubuntu-22.04
    env:
      ARTIFACT_DIR: ${{ github.workspace }}/artifacts/source
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install Required Packages
      run: |
        sudo apt-get install build-essential libtool autotools-dev automake pkg-config libssl-dev libevent-dev bsdmainutils python3
        sudo apt-get install libboost-system-dev libboost-filesystem-dev libboost-chrono-dev libboost-program-options-dev libboost-test-dev libboost-thread-dev
        sudo apt-get install libboost-all-dev
        sudo apt-get install libdb5.3-dev libdb5.3++-dev
        sudo apt-get update
        sudo apt-get install libminiupnpc-dev
        sudo apt-get install libzmq3-dev
        sudo apt-get install libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools libprotobuf-dev protobuf-compiler
        sudo apt-get install libqrencode-dev
    - name: Create Distribution Tarball
      run: |
        ./autogen.sh
        ./configure --with-incompatible-bdb --with-miniupnpc CXXFLAGS="-std=c++11"
        make dist
    - name: Download Dependencies
      run: make -C depends download
    - name: Create Dependencies Tarball
      run: tar -czf depends.tar.gz depends
    - name: Prepare Files for Artifact
      run: |
        mkdir -p $ARTIFACT_DIR
        mv depends.tar.gz dingocoin-*.tar.gz $ARTIFACT_DIR
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: source
        path: ${{ env.ARTIFACT_DIR }}
  build-linux:
    name: Build for Linux
    needs: create-source-distribution
    runs-on: ubuntu-22.04
    env:
      ARTIFACT_DIR: ${{ github.workspace }}/artifacts/linux
      TEST_LOG_ARTIFACT_DIR: test-logs
    steps:
    - name: Getting Source
      uses: actions/download-artifact@v4
      with:
        name: source
    - name: Extract Archives
      run: |
        tar -xzf depends.tar.gz
        tar -xzf dingocoin-*.tar.gz --strip-components=1
    - name: Install Required Packages
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-zmq
    - name: Build Dependencies
      run: make -C depends -j$(nproc)
    - name: Build Dingocoin
      run: |
        ./configure --prefix=$(realpath depends/x86_64-pc-linux-gnu) --disable-tests
        make -j$(nproc)
    - name: Prepare Files for Artifact
      run: |
        mkdir -p $ARTIFACT_DIR
        mv ./src/{dingocoin-cli,dingocoin-tx,dingocoind,qt/dingocoin-qt} $ARTIFACT_DIR
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-binaries
        path: ${{ env.ARTIFACT_DIR }}
  build-windows:
    name: Build for Windows
    needs: create-source-distribution
    runs-on: ubuntu-22.04
    env:
      ARTIFACT_DIR: ${{ github.workspace }}/artifacts/windows
    steps:
    - name: Getting Source
      uses: actions/download-artifact@v4
      with:
        name: source
    - name: Extract Archives
      run: |
        tar -xzf depends.tar.gz
        tar -xzf dingocoin-*.tar.gz --strip-components=1
    - name: Install Required Packages
      run: |
        sudo apt-get update
        sudo apt-get install -y g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64
    - name: Switch MinGW GCC and G++ to POSIX Threading
      run: |
        sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
        sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
    - name: Build Dependencies
      run: make -C depends -j$(nproc) HOST=x86_64-w64-mingw32
    - name: Build Dingocoin
      run: |
        ./configure --prefix=$(realpath depends/x86_64-w64-mingw32)
        make -j$(nproc)
    - name: Prepare Files for Artifact
      run: |
        mkdir -p $ARTIFACT_DIR
        mv ./src/{dingocoin-cli.exe,dingocoin-tx.exe,dingocoind.exe,qt/dingocoin-qt.exe} $ARTIFACT_DIR
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: ${{ env.ARTIFACT_DIR }}

  build-macos:
    name: Build for macOS (arm64)
    needs: create-source-distribution
    runs-on: macos-15
    env:
      ARTIFACT_DIR: ${{ github.workspace }}/artifacts/macos
      HOST: aarch64-apple-darwin
    steps:
      - name: Getting Source
        uses: actions/download-artifact@v4
        with:
          name: source
      - name: Extract Archives
        run: |
          tar -xzf depends.tar.gz
          tar -xzf dingocoin-*.tar.gz --strip-components=1
      - name: Install build tools
        run: |
          brew install autoconf automake libtool pkg-config gnu-sed openssl@3
          pip3 install setuptools --break-system-packages
      - name: Build Dependencies
        run: make -C depends -j$(sysctl -n hw.ncpu) HOST=$HOST
      - name: Build Dingocoin
        run: |
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          ./configure --prefix=$(realpath depends/$HOST) --with-gui=qt5 --enable-reduce-exports \
            LDFLAGS="-L${OPENSSL_PREFIX}/lib" CPPFLAGS="-I${OPENSSL_PREFIX}/include"
          make -j$(sysctl -n hw.ncpu)
      - name: Prepare Files for Artifact
        run: |
          mkdir -p $ARTIFACT_DIR
          cp ./depends/$HOST/bin/dingocoin* $ARTIFACT_DIR/ || cp ./src/{dingocoind,dingocoin-cli,dingocoin-tx} ./src/qt/dingocoin-qt $ARTIFACT_DIR/
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: ${{ env.ARTIFACT_DIR }}
