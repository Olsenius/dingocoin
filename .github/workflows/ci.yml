name: Continuous Integration

on:
  push:
    paths-ignore:
      - '**/*.md'
  pull_request:
    paths-ignore:
      - 'doc/**'
      - 'contrib/**'
      - '**/*.md'

jobs:
  # Temporarily disabled other builds while debugging macOS
  # build:
  #   ... (see git history for full config)

  build-macos:
    name: ${{ matrix.name }}

    env:
      MAKEJOBS: "-j4"

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: arm64-macos
            host: aarch64-apple-darwin
            os: macos-15
            dep-opts: ""
            config-opts: "--with-gui=qt5"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew install autoconf automake libtool pkg-config gnu-sed
          pip3 install setuptools --break-system-packages

      - name: Dependency cache
        uses: actions/cache@v4
        env:
          cache-name: depends
        with:
          path: ./depends/built
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('depends/packages/*', '.github/workflows/ci.yml') }}

      - name: Build depends
        run: |
          make $MAKEJOBS -C depends HOST=${{ matrix.host }} ${{ matrix.dep-opts }}

      - name: Build Dingocoin
        run: |
          ./autogen.sh
          ./configure --prefix=$(pwd)/depends/${{ matrix.host }} ${{ matrix.config-opts }} --enable-reduce-exports || ( cat config.log && false)
          make $MAKEJOBS || ( echo "Build failure. Verbose build follows." && make V=1 ; false )

      - name: Run tests
        continue-on-error: true  # Tests may fail due to BDB issues on ARM64
        run: |
          make check VERBOSE=1

      - name: Upload artifacts
        if: always()  # Upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: dingocoin-${{ github.sha }}-${{ matrix.name }}
          path: |
            depends/${{ matrix.host }}/bin/dingocoin*
